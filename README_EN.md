# Backend Home Challenge

## Description

REST service for Parrot Software's backend challenge.

## Stack

- [ ] [Python 3.9+](https://www.python.org/)
- [ ] [Fast API](https://fastapi.tiangolo.com/)
- [ ] [PostgreSQL 16+](https://www.postgresql.org/)
- [ ] [Docker (optional)](https://www.docker.com/)

## Environments

- **Localhost** localhost:8000/
- **Development** undefined
- **Production** undefined
- **Testing** undefined

## Building and running

### Installation

Create virtual environment.

```bash
python -m venv venv

source venv/bin/activate # Linux/Mac

.\venv\Scripts\activate # Windows
```

Install project dependencies.

```bash
pip install -r requirements.txt
```

### Initial Configuration

Configure environment variables.

```bash
cp .env.example .env
```

Edit the `.env` file with your settings.

Run migrations.

```bash
python scripts/db.py init
```

When running migrations, a default admin user will be created:

- Email: admin@email.com
- Name: Admin

This user can be used for the first login and system configuration.

### Execution

Start the server.

```bash
uvicorn src.main:app --reload --host 0.0.0.0 --port 8000
```

## API Endpoints

- `POST /api/v1/auth/login` - User login
- `POST /api/v1/users` - Create user
- `POST /api/v1/orders` - Create order
- `GET /api/v1/orders/report` - Sales report

See complete documentation at `/docs`

## Tests

Run all tests

```bash
pytest
```

Specific tests

```bash
pytest tests/unit/
pytest tests/integration/
```

## Docker

### Build

Build image. Enter the `container` folder and run the `build.sh` script.

```bash
./build.sh
```

Run container.

```bash
docker run -p 8000:8000 backend-home-challenge
```

## Migrations

The project includes a CLI tool for database management:

```bash
# Initialize the database with migrations
python scripts/db.py init

# Create a new migration
python scripts/db.py create-migration "description"

# Apply pending migrations
python scripts/db.py upgrade

# Revert the last migration
python scripts/db.py downgrade

# Show migration status
python scripts/db.py status

# Reset the database (use with caution!)
python scripts/db.py reset
```

## Architecture

### Overview

The project implements Clean Architecture with the following layers:

1. **Domain**: Business rules and models
2. **Application**: Use cases
3. **Infrastructure**: Technical implementations

### Modules

### Auth

Authentication management:

- JWT
- DTOs
- Use cases (login)

### Shared

Reusable components:

- Value Objects (Email, Money)
- Domain exceptions
- Configuration
- Middleware
- Utilities

### User

User management:

- Domain model (User)
- Abstract repository
- PostgreSQL implementation
- DTOs
- Use cases (create user)

### Order

Order management:

- Domain models (Order, OrderItem)
- Abstract repository
- PostgreSQL implementation
- DTOs
- Use cases (create order, reports)
- Business validations

## Technical Decisions

### Database

- PostgreSQL for consistency and reporting
- Migrations with Alembic via scripts to facilitate implementation in different environments
- Database indexes for optimization

**Tables**

- **users:** id, name, email, password, created_at
- **orders:** id, customer_name, waiter_id, created_at
- **order_items:** id, order_id, product_name, unit_price, quantity, created_at

**Indexes**

- **ix_users_email:** Index for email searches (login and validations)
- **ix_order_items_product_stats:** Composite index for sales reports by product and date

### Authentication

- Stateless JWT
- No refresh tokens
- Email validation

### Testing

- Shared fixtures
- In-memory SQLite database
- Strategic mocks

### API

- REST with FastAPI
- Pydantic validation
- OpenAPI documentation
- Mermaid diagrams

### Diagrams

- [General Architecture](docs/diagrams/general_architecture.mmd)
- [Authentication Flow Diagram](docs/diagrams/authentication_flow.mmd)
- [Order Creation Flow Diagram](docs/diagrams/order_creation_flow.mmd)
- [Domain Model](docs/diagrams/domain_model.mmd)
- [Data Flow](docs/diagrams/data_flow.mmd)

### Project Structure

```
backend-home-challenge/
├── alembic/                    # Database configuration and migrations
│   ├── versions/               # Migration files
│   └── env.py                  # Alembic environment configuration
│
├── container/                  # Docker build files
│   ├── Dockerfile             # Image definition
│   └── build.sh               # Build script
│
├── docs/                       # Project documentation
│   └── diagrams/              # Architecture and flow diagrams
│
├── logs/                      # Log files generated by the application
│
├── scripts/                   # Utility scripts
│   ├── db.py                 # CLI for database management
│   └── init_db.py            # Database initialization
│
├── src/                       # Main source code
│   ├── auth/                 # Authentication module
│   │   ├── application/      # Use cases and DTOs
│   │   └── infrastructure/   # JWT implementation and routes
│   │
│   ├── order/                # Orders module
│   │   ├── application/      # Use cases and DTOs
│   │   ├── domain/          # Models and business rules
│   │   └── infrastructure/   # Repositories and routes
│   │
│   ├── shared/               # Shared components
│   │   ├── domain/          # Value objects and exceptions
│   │   ├── application/     # Common DTOs
│   │   └── infrastructure/  # Configuration and middleware
│   │
│   ├── user/                # Users module
│   │   ├── application/     # Use cases and DTOs
│   │   ├── domain/         # Models and business rules
│   │   └── infrastructure/ # Repositories and routes
│   │
│   └── main.py             # Application entry point
│
├── tests/                   # Automated tests
│   ├── integration/        # Integration tests
│   │   ├── api/           # Endpoint tests
│   │   └── infrastructure/# Repository tests
│   │
│   ├── unit/              # Unit tests
│   │   ├── application/   # Use case tests
│   │   └── domain/       # Model and service tests
│   │
│   └── conftest.py        # Pytest configuration and fixtures
│
├── .env.example           # Environment variables template
├── .gitignore            # Files ignored by git
├── alembic.ini           # Alembic configuration
├── pyproject.toml        # Python tools configuration
├── README.md             # Main documentation
└── requirements.txt      # Project dependencies
```
